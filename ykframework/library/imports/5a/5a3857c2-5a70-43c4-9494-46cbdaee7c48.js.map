{"version":3,"sources":["assets\\YK\\core\\utils\\TimeDelay.ts"],"names":[],"mappings":";;;;;AAAA,uCAA4C;AAEtC,IAAA,kBAAqC,EAAnC,oBAAO,EAAE,sBAA0B,CAAC;AAE5C;IAA+B,6BAAY;IAD3C;QAAA,qEA0LC;QA3KW,qBAAe,GAAa,IAAI,mBAAQ,EAAE,CAAC;QAuBnD;;WAEG;QACI,YAAM,GAAW,CAAC,CAAA;QACjB,WAAK,GAAyB,IAAI,KAAK,EAAiB,CAAA;QACxD,WAAK,GAAyB,IAAI,KAAK,EAAiB,CAAA;QACxD,cAAQ,GAAyB,IAAI,KAAK,EAAiB,CAAA;QAC3D,UAAI,GAAyB,IAAI,KAAK,EAAiB,CAAA;QAgFvD,cAAQ,GAAW,CAAC,CAAA;QACpB,eAAS,GAAW,CAAC,CAAA;;IA4DjC,CAAC;kBAzLY,SAAS;IAIlB,sBAAkB,qBAAQ;aAA1B;YACI,IAAI,IAAI,CAAC,SAAS,IAAI,IAAI,IAAI,CAAC,WAAS,CAAC,SAAS,EAAE;gBAChD,IAAI,EAAE,GAAG,IAAI,EAAE,CAAC,IAAI,CAAC,YAAY,CAAC,CAAA;gBAClC,EAAE,CAAC,IAAI,CAAC,kBAAkB,CAAC,EAAE,CAAC,CAAC;gBAC/B,IAAI,CAAC,SAAS,GAAG,EAAE,CAAC,YAAY,CAAC,WAAS,CAAC,CAAA;aAC9C;YACD,OAAO,IAAI,CAAC,SAAS,CAAA;QACzB,CAAC;;;OAAA;IAGkD,CAAC;IAEpD;;OAEG;IACI,6BAAS,GAAhB,UAAiB,QAAkB,EAAE,OAAY;QAAE,uBAAqB;aAArB,UAAqB,EAArB,qBAAqB,EAArB,IAAqB;YAArB,sCAAqB;;;QACpE,IAAI,CAAC,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE;YAC9C,CAAA,KAAA,IAAI,CAAC,eAAe,CAAA,CAAC,GAAG,YAAC,QAAQ,EAAE,OAAO,SAAK,aAAa,GAAE;SACjE;aAAM;YACH,OAAO,CAAC,IAAI,CAAC,oBAAoB,CAAC,CAAA;SACrC;IACL,CAAC;IACD;;OAEG;IACI,gCAAY,GAAnB,UAAoB,QAAkB,EAAE,OAAY;QAChD,IAAI,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE;YAC7C,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;SAClD;IACL,CAAC;IAYO,+BAAW,GAAnB;QACI,IAAI,CAAgB,CAAC;QACrB,IAAI,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,EAAE;YACtB,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAA;SACtB;;YAEG,CAAC,GAAG,IAAI,aAAa,EAAE,CAAC;QAC5B,OAAO,CAAC,CAAC;IACb,CAAC;IAEO,gCAAY,GAApB,UAAqB,CAAgB;QACjC,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,CAAA;QAC7B,CAAC,CAAC,OAAO,GAAG,CAAC,CAAA;QACb,CAAC,CAAC,OAAO,GAAG,KAAK,CAAA;QACjB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;IACrB,CAAC;IAGM,0BAAM,GAAb,UAAc,QAAuB,EAAE,OAAY;QAC/C,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAoB,EAAE,KAAa,EAAE,GAAyB;YACnF,OAAO,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,OAAO,CAAA;QACjE,CAAC,CAAC,CAAA;QAEF,IAAI,CAAC,IAAI,IAAI,EAAE;YACX,OAAO,IAAI,CAAA;SACd;QACD,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAoB,EAAE,KAAa,EAAE,GAAyB;YAC/E,OAAO,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,OAAO,CAAA;QACjE,CAAC,CAAC,CAAA;QACF,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,CAAC,CAAC,OAAO,EAAE;YACzB,OAAO,IAAI,CAAA;SACd;QACD,OAAO,KAAK,CAAA;IAChB,CAAC;IAEM,uBAAG,GAAV,UAAW,QAAgB,EAAE,MAAc,EAAE,QAAuB,EAAE,OAAY;QAAE,uBAAqB;aAArB,UAAqB,EAArB,qBAAqB,EAArB,IAAqB;YAArB,sCAAqB;;QACrG,IAAI,CAAgB,CAAC;QACrB,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAoB,EAAE,KAAa,EAAE,GAAyB;YAC/E,OAAO,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,OAAO,CAAA;QACjE,CAAC,CAAC,CAAA;QAEF,IAAI,CAAC,IAAI,IAAI,EAAE;YACX,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAoB,EAAE,KAAa,EAAE,GAAyB;gBAC/E,OAAO,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,OAAO,CAAA;YACjE,CAAC,CAAC,CAAA;SACL;QAED,IAAI,CAAC,IAAI,IAAI,EAAE;YACX,CAAC,GAAG,IAAI,CAAC,WAAW,EAAE,CAAA;YACtB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;SACtB;QAED,CAAC,CAAC,GAAG,OAAL,CAAC,GAAK,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,OAAO,SAAK,aAAa,GAAC;QAC5D,CAAC,CAAC,OAAO,GAAG,KAAK,CAAA;QACjB,CAAC,CAAC,OAAO,GAAG,CAAC,CAAA;IACjB,CAAC;IAEM,0BAAM,GAAb,UAAc,QAAuB,EAAE,OAAY;QAC/C,IAAI,SAAS,GAAG,CAAC,CAAC,CAAA;QAClB,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAoB,EAAE,KAAa,EAAE,GAAyB;YACnF,IAAI,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,OAAO,EAAE;gBACxD,SAAS,GAAG,KAAK,CAAA;gBACjB,OAAO,IAAI,CAAA;aACd;iBACI;gBACD,OAAO,KAAK,CAAA;aACf;QACL,CAAC,CAAC,CAAA;QACF,IAAI,CAAC,IAAI,IAAI,EAAE;YACX,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,SAAS,EAAE,CAAC,CAAC,CAAA;YAC/B,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,CAAA;SACvB;QAED,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,UAAC,KAAoB,EAAE,KAAa,EAAE,GAAyB,IAAO,OAAO,KAAK,CAAC,QAAQ,IAAI,QAAQ,IAAI,KAAK,CAAC,OAAO,IAAI,OAAO,CAAA,CAAC,CAAC,CAAC,CAAA;QAC1J,IAAI,CAAC,IAAI,IAAI;YACT,CAAC,CAAC,OAAO,GAAG,IAAI,CAAA;IACxB,CAAC;IAKD,yBAAK,GAAL;QACI,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;IAC/B,CAAC;IAED,0BAAM,GAAN,UAAO,EAAE;;QACL,IAAI,IAAI,CAAC,eAAe,IAAI,IAAI,EAAE;YAC9B,IAAI,CAAC,eAAe,CAAC,GAAG,EAAE,CAAC;SAC9B;QACD,IAAI,CAAC,SAAS,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAA;QACpD,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,CAAA;QAE1B,KAAK,IAAI,KAAK,GAAG,CAAC,EAAE,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,KAAK,EAAE,EAAE;YACpD,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;YAC1B,IAAI,CAAC,CAAC,OAAO,EAAE;gBACX,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;gBACrB,SAAS;aACZ;YAED,CAAC,CAAC,OAAO,IAAI,IAAI,CAAC,SAAS,CAAA;YAC3B,IAAI,CAAC,CAAC,OAAO,GAAG,CAAC,CAAC,QAAQ,EAAE;gBACxB,SAAQ;aACX;YAED,CAAC,CAAC,OAAO,GAAG,CAAC,CAAC;YAEd,IAAI,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE;gBACd,CAAC,CAAC,MAAM,EAAE,CAAA;gBACV,IAAI,CAAC,CAAC,MAAM,IAAI,CAAC,EAAE;oBACf,CAAC,CAAC,OAAO,GAAG,IAAI,CAAA;oBAChB,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;iBACxB;aACJ;YACD,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,MAAM,CAAA;YACtB,IAAI,CAAC,CAAC,QAAQ,IAAI,IAAI,EAAE;gBACpB,IAAI;oBACA,CAAA,KAAA,CAAC,CAAC,QAAQ,CAAA,CAAC,IAAI,YAAC,CAAC,CAAC,OAAO,SAAK,CAAC,CAAC,KAAK,GAAC;iBACzC;gBAAC,OAAO,KAAK,EAAE;oBACZ,CAAC,CAAC,OAAO,GAAG,IAAI,CAAA;iBACnB;aACJ;SACJ;QACD,IAAI,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAA;QAC9B,OAAO,GAAG,EAAE;YACR,IAAI,GAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAA;YAC3B,IAAI,OAAK,GAAG,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,GAAC,CAAC,CAAA;YACjC,IAAI,GAAC,CAAC,OAAO,IAAI,OAAK,IAAI,CAAC,CAAC,EAAE;gBAC1B,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,OAAK,EAAE,CAAC,CAAC,CAAA;gBAC3B,IAAI,CAAC,YAAY,CAAC,GAAC,CAAC,CAAA;aACvB;YACD,GAAG,EAAE,CAAA;SACR;QACD,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAA;QACvB,OAAO,GAAG,EAAE;YACR,IAAI,GAAC,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,EAAE,CAAA;YACxB,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAC,CAAC,CAAA;YAClB,GAAG,EAAE,CAAA;SACR;IACL,CAAC;;IArLa,mBAAS,GAAY,KAAK,CAAC;IAC1B,mBAAS,GAAc,IAAI,CAAA;IAHjC,SAAS;QADrB,OAAO;OACK,SAAS,CAyLrB;IAAD,gBAAC;CAzLD,AAyLC,CAzL8B,EAAE,CAAC,SAAS,GAyL1C;AAzLY,8BAAS;AA2LtB;IAAA;IAgBA,CAAC;IAPU,2BAAG,GAAV,UAAW,QAAgB,EAAE,MAAc,EAAE,QAAuB,EAAE,OAAY;QAAE,eAAa;aAAb,UAAa,EAAb,qBAAa,EAAb,IAAa;YAAb,8BAAa;;QAC7F,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAA;QACxB,IAAI,CAAC,MAAM,GAAG,MAAM,CAAA;QACpB,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAA;QACxB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAA;QAClB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAA;IAC1B,CAAC;IACL,oBAAC;AAAD,CAhBA,AAgBC,IAAA;AAhBY,sCAAa","file":"","sourceRoot":"/","sourcesContent":["import { Listener, Func } from \"./Listener\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n@ccclass\r\nexport class TimeDelay extends cc.Component {\r\n\r\n    public static isQuiting: boolean = false;\r\n    private static mInstance: TimeDelay = null\r\n    public static get instance() {\r\n        if (this.mInstance == null && !TimeDelay.isQuiting) {\r\n            let no = new cc.Node(\"_TimeDelay\")\r\n            cc.game.addPersistRootNode(no);\r\n            this.mInstance = no.addComponent(TimeDelay)\r\n        }\r\n        return this.mInstance\r\n    }\r\n\r\n\r\n    private mUpdateListener: Listener = new Listener();;\r\n\r\n    /**\r\n     * 添加一个每帧回调\r\n     */\r\n    public addUpdate(callback: Function, thisObj: any, ...callbackParam: any) {\r\n        if (!this.mUpdateListener.has(callback, thisObj)) {\r\n            this.mUpdateListener.add(callback, thisObj, ...callbackParam);\r\n        } else {\r\n            console.warn(\"repeat add  update\")\r\n        }\r\n    }\r\n    /**\r\n     * 移除一个每帧回调\r\n     */\r\n    public removeUpdate(callback: Function, thisObj: any) {\r\n        if (this.mUpdateListener.has(callback, thisObj)) {\r\n            this.mUpdateListener.remove(callback, thisObj);\r\n        }\r\n    }\r\n\r\n\r\n\r\n    /**\r\n     * 当前事件执行的次数\r\n     */\r\n    public repeat: number = 0\r\n    private items: Array<TimeDelayData> = new Array<TimeDelayData>()\r\n    private toAdd: Array<TimeDelayData> = new Array<TimeDelayData>()\r\n    private toRemove: Array<TimeDelayData> = new Array<TimeDelayData>()\r\n    private pool: Array<TimeDelayData> = new Array<TimeDelayData>()\r\n    private getFromPool(): TimeDelayData {\r\n        let t: TimeDelayData;\r\n        if (this.pool.length > 0) {\r\n            t = this.pool.pop()\r\n        }\r\n        else\r\n            t = new TimeDelayData();\r\n        return t;\r\n    }\r\n\r\n    private returnToPool(t: TimeDelayData) {\r\n        t.set(0, 0, null, null, null)\r\n        t.elapsed = 0\r\n        t.deleted = false\r\n        this.pool.push(t)\r\n    }\r\n\r\n\r\n    public exists(callback: TimerCallback, thisObj: any) {\r\n        let t = this.toAdd.find((value: TimeDelayData, index: number, obj: Array<TimeDelayData>) => {\r\n            return value.callback == callback && value.thisObj == thisObj\r\n        })\r\n\r\n        if (t != null) {\r\n            return true\r\n        }\r\n        t = this.items.find((value: TimeDelayData, index: number, obj: Array<TimeDelayData>) => {\r\n            return value.callback == callback && value.thisObj == thisObj\r\n        })\r\n        if (t != null && !t.deleted) {\r\n            return true\r\n        }\r\n        return false\r\n    }\r\n\r\n    public add(interval: number, repeat: number, callback: TimerCallback, thisObj: any, ...callbackParam: any) {\r\n        let t: TimeDelayData;\r\n        t = this.items.find((value: TimeDelayData, index: number, obj: Array<TimeDelayData>) => {\r\n            return value.callback == callback && value.thisObj == thisObj\r\n        })\r\n\r\n        if (t == null) {\r\n            t = this.toAdd.find((value: TimeDelayData, index: number, obj: Array<TimeDelayData>) => {\r\n                return value.callback == callback && value.thisObj == thisObj\r\n            })\r\n        }\r\n\r\n        if (t == null) {\r\n            t = this.getFromPool()\r\n            this.toAdd.push(t);\r\n        }\r\n\r\n        t.set(interval, repeat, callback, thisObj, ...callbackParam)\r\n        t.deleted = false\r\n        t.elapsed = 0\r\n    }\r\n\r\n    public Remove(callback: TimerCallback, thisObj: any) {\r\n        let findindex = -1\r\n        let t = this.toAdd.find((value: TimeDelayData, index: number, obj: Array<TimeDelayData>) => {\r\n            if (value.callback == callback && value.thisObj == thisObj) {\r\n                findindex = index\r\n                return true\r\n            }\r\n            else {\r\n                return false\r\n            }\r\n        })\r\n        if (t != null) {\r\n            this.toAdd.splice(findindex, 1)\r\n            this.returnToPool(t)\r\n        }\r\n\r\n        t = this.items.find((value: TimeDelayData, index: number, obj: Array<TimeDelayData>) => { return value.callback == callback && value.thisObj == thisObj })\r\n        if (t != null)\r\n            t.deleted = true\r\n    }\r\n\r\n\r\n    private lastTime: number = 0\r\n    private deltaTime: number = 0\r\n    start() {\r\n        this.lastTime = Date.now();\r\n    }\r\n\r\n    update(dt) {\r\n        if (this.mUpdateListener != null) {\r\n            this.mUpdateListener.run();\r\n        }\r\n        this.deltaTime = (Date.now() - this.lastTime) / 1000\r\n        this.lastTime = Date.now()\r\n\r\n        for (var index = 0; index < this.items.length; index++) {\r\n            var t = this.items[index];\r\n            if (t.deleted) {\r\n                this.toRemove.push(t)\r\n                continue;\r\n            }\r\n\r\n            t.elapsed += this.deltaTime\r\n            if (t.elapsed < t.interval) {\r\n                continue\r\n            }\r\n\r\n            t.elapsed = 0;\r\n\r\n            if (t.repeat > 0) {\r\n                t.repeat--\r\n                if (t.repeat == 0) {\r\n                    t.deleted = true\r\n                    this.toRemove.push(t)\r\n                }\r\n            }\r\n            this.repeat = t.repeat\r\n            if (t.callback != null) {\r\n                try {\r\n                    t.callback.call(t.thisObj, ...t.param)\r\n                } catch (error) {\r\n                    t.deleted = true\r\n                }\r\n            }\r\n        }\r\n        let len = this.toRemove.length\r\n        while (len) {\r\n            let t = this.toRemove.pop()\r\n            let index = this.items.indexOf(t)\r\n            if (t.deleted && index != -1) {\r\n                this.items.splice(index, 1)\r\n                this.returnToPool(t)\r\n            }\r\n            len--\r\n        }\r\n        len = this.toAdd.length\r\n        while (len) {\r\n            let t = this.toAdd.pop()\r\n            this.items.push(t)\r\n            len--\r\n        }\r\n    }\r\n\r\n}\r\n\r\nexport class TimeDelayData {\r\n    public repeat: number\r\n    public interval: number\r\n    public param: any[]\r\n    public callback: TimerCallback\r\n    public thisObj: any\r\n    public deleted: boolean\r\n    public elapsed: number\r\n\r\n    public set(interval: number, repeat: number, callback: TimerCallback, thisObj: any, ...param: any): void {\r\n        this.interval = interval\r\n        this.repeat = repeat\r\n        this.callback = callback\r\n        this.param = param\r\n        this.thisObj = thisObj\r\n    }\r\n}\r\n\r\nexport type TimerCallback = (...param: any) => void"]}