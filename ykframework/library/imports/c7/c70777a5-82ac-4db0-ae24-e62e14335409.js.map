{"version":3,"sources":["assets\\YK\\core\\task\\Task.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { TimeDelay } from \"../utils/TimeDelay\";\r\nimport { Func } from \"../utils/Listener\";\r\n\r\nexport enum Status {\r\n    None = 0,\r\n    Running,\r\n    Success,\r\n    Failure\r\n}\r\n\r\nexport abstract class Task {\r\n    private latch: boolean;\r\n    protected mStatus: Status = Status.None;\r\n    protected mErr = \"\";\r\n    protected mProgress: number;\r\n    protected mOwnerSystem: any;\r\n    protected mStartedTime: number;\r\n    public onFinish: Func;\r\n\r\n    public get progress(): number {\r\n        return this.mProgress;\r\n    }\r\n\r\n\r\n    public elapsedTime(): number {\r\n\r\n        return cc.director.getTotalTime() - this.mStartedTime;\r\n    }\r\n\r\n    public get status(): Status {\r\n        return this.mStatus;\r\n    }\r\n\r\n\r\n    public get taskName(): string {\r\n        return \"\";\r\n    }\r\n\r\n    public get errInfo(): string {\r\n        return this.mErr;\r\n    }\r\n\r\n    public get isRunning(): boolean {\r\n        return this.status == Status.Running;\r\n    }\r\n\r\n    public setComplete(callback: Func): Task {\r\n        this.onFinish = callback;\r\n        return this;\r\n    }\r\n\r\n    public execute(owner: any = null) {\r\n        this.mProgress = 0;\r\n        if (!this.isRunning) {\r\n            TimeDelay.instance.addUpdate(this.update, this, [owner])\r\n        }\r\n    }\r\n\r\n    public tick(owner: any): Status {\r\n        if (this.status == Status.Running) {\r\n            this.onUpdate();\r\n            this.latch = false;\r\n            return this.mStatus;\r\n        }\r\n        //如果任务结束了跳过这一帧//\r\n        if (this.latch) {\r\n            this.latch = false;\r\n            return this.mStatus;\r\n        }\r\n        this.mStartedTime = cc.director.getTotalTime();\r\n        this.mStatus = Status.Running;\r\n        this.mOwnerSystem = owner;\r\n        this.onExecute();\r\n        if (Status.Running == this.mStatus) {\r\n            this.onUpdate();\r\n        }\r\n        return this.mStatus;\r\n    }\r\n\r\n    private update(owner: any) {\r\n        if (this.tick(owner) != Status.Running) {\r\n            if (this.onFinish != null){\r\n                this.onFinish.run([this.status == Status.Success]);\r\n            }\r\n            TimeDelay.instance.removeUpdate(this.update, this);\r\n        }\r\n    }\r\n\r\n    public endAction(success = true) {\r\n        if (this.status != Status.Running) {\r\n            this.onForcedStop();\r\n            return;\r\n        }\r\n        this.latch = true;\r\n        this.mStatus = success ? Status.Success : Status.Failure;\r\n        this.mProgress = this.mStatus == Status.Success ? 1 : 0;\r\n\r\n        this.onStop();\r\n    }\r\n\r\n    public reset() {\r\n        this.latch = false\r\n        this.mStatus = Status.None;\r\n        TimeDelay.instance.removeUpdate(this.update, this);\r\n        this.onReset();\r\n        this.onForcedStop();\r\n    }\r\n\r\n    protected onExecute() {\r\n    }\r\n\r\n    protected onUpdate() {\r\n    }\r\n\r\n    protected onStop() {\r\n    }\r\n\r\n    protected onReset() {\r\n\r\n    }\r\n\r\n    protected onForcedStop() {\r\n    }\r\n}"]}